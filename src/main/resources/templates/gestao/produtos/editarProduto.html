<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragmentos/head :: head('Editar Produto #' + ${produto.id}, '/css/novoProduto.css')}"></head>
<body>
<header th:replace="~{fragmentos/header :: headerGrande}"></header>
<div th:replace="~{fragmentos/header :: headerPequeno}"></div>

<main class="bg-pastel py-5">
  <div class="container-novo">
    <h2 class="text-dourado mb-4" th:text="'Editar Produto #' + ${produto.id}"></h2>
    <form th:object="${produto}" th:action="'/gestao-produtos/editar/' + ${produto.id}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="imagensExcluidas" id="imagensExcluidas" />
      <div class="mb-3">
        <label for="nome" class="form-label">Nome</label>
        <input th:field="*{nome}" name="nome" type="text" class="form-control" id="nome" required>
      </div>
      <div class="mb-3">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea th:field="*{descricao}" name="descricao" class="form-control" id="descricao" rows="3" placeholder="Digite a descrição do produto"></textarea>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="preco" class="form-label">Preço</label>
          <input th:field="*{preco}" name="preco" type="number" step="0.01" class="form-control" id="preco" placeholder="Digite o preço" required>
        </div>
        <div class="col">
          <label for="precoDePor" class="form-label">Preço DePor</label>
          <input th:field="*{precoDePor}" name="precoDePor" type="number" step="0.01" class="form-control" id="precoDePor" placeholder="Digite o preço promocional">
        </div>
      </div>

      <!-- Container de upload de imagens -->
      <div class="image-upload-container">
        <label for="fotos" class="custom-file-label">
          <div class="upload-region">
            <i class="fas fa-upload"></i> Selecione ou arraste suas imagens aqui
          </div>
        </label>
        <input id="fotos" name="fotos" type="file" accept="image/*" multiple style="display: none;">
        <div id="preview-container" class="row gy-3">
          <div th:each="imagem : ${imagens}" class="col-md-3 position-relative">
            <img th:src="@{'/upload/' + ${imagem.nomeArquivo}}" alt="Imagem do Produto">
            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" th:data-imagem-id="${imagem.id}" onclick="removerImagem(this)">x</button>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-dourado mt-4 w-100">Salvar Produto</button>
    </form>
  </div>

</main>

<footer th:replace="~{fragmentos/footer :: footer}"></footer>
<script th:replace="~{fragmentos/bootStrap :: script}"></script>

<script th:replace="~{fragmentos/bootStrap :: script}"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const fotosInput = document.getElementById('fotos');
    const previewContainer = document.getElementById('preview-container');
    let selectedFiles = []; // Lista de arquivos gerenciada manualmente

    fotosInput.addEventListener('change', () => {
      // Adiciona novos arquivos sem duplicar
      const newFiles = Array.from(fotosInput.files);
      newFiles.forEach(file => {
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          selectedFiles.push(file);
        }
      });

      renderPreview();
      updateInputFiles();
    });

    // Disparar o input de arquivos ao clicar na região da div
    const uploadRegion = document.querySelector('.upload-region');
    uploadRegion.addEventListener('click', (event) => {
      event.preventDefault();
      fotosInput.click();
    });

    function renderPreview() {
      // Atualiza o preview apenas com novas imagens
      const existingPreviews = Array.from(previewContainer.children);
      const existingFiles = existingPreviews.map(preview => preview.getAttribute('data-file-name'));

      selectedFiles.forEach((file) => {
        if (existingFiles.includes(file.name)) return;

        const reader = new FileReader();
        reader.onload = () => {
          const colDiv = document.createElement('div');
          colDiv.className = 'col-md-3 position-relative';
          colDiv.setAttribute('data-file-name', file.name);

          const img = document.createElement('img');
          img.src = reader.result;
          img.className = 'img-fluid rounded border';

          const closeButton = document.createElement('button');
          closeButton.className = 'btn btn-danger btn-sm position-absolute top-0 end-0';
          closeButton.textContent = 'x';
          closeButton.type = 'button';

          // Configura o evento para remover o arquivo da lista e atualizar o preview
          closeButton.addEventListener('click', () => {
            // Remover o arquivo da lista selectedFiles
            selectedFiles = selectedFiles.filter(f => f.name !== file.name);

            // Atualiza o campo "imagensExcluidas"
            addToExcludedImages(file.name);

            // Remover a imagem do DOM
            colDiv.remove();

            // Atualiza os arquivos no input
            updateInputFiles();
          });

          colDiv.appendChild(img);
          colDiv.appendChild(closeButton);
          previewContainer.appendChild(colDiv);
        };
        reader.readAsDataURL(file);
      });
    }

    function updateInputFiles() {
      // Atualiza os arquivos no input de acordo com `selectedFiles`
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => dataTransfer.items.add(file));
      fotosInput.files = dataTransfer.files;
    }

    function addToExcludedImages(imageName) {
      // Adiciona o nome da imagem ao campo "imagensExcluidas"
      let imagensExcluidas = document.getElementById('imagensExcluidas').value;
      imagensExcluidas = imagensExcluidas ? imagensExcluidas.split(',') : [];
      if (!imagensExcluidas.includes(imageName)) {
        imagensExcluidas.push(imageName);
        document.getElementById('imagensExcluidas').value = imagensExcluidas.join(',');
      }
    }
  });

  function adicionarImagensExistentes(imagensExistentes) {
    let imagensExcluidas = document.getElementById('imagensExcluidas').value;

    // Se o campo "imagensExcluidas" estiver vazio, inicialize como um array vazio
    if (imagensExcluidas.trim() === '') {
      imagensExcluidas = [];
    } else {
      imagensExcluidas = imagensExcluidas.split(',');
    }

    // Adicionar imagens existentes ao campo
    imagensExistentes.forEach(function(imagemId) {
      if (!imagensExcluidas.includes(imagemId)) {
        imagensExcluidas.push(imagemId);
      }
    });

    // Atualizar o campo "imagensExcluidas" com as imagens existentes
    document.getElementById('imagensExcluidas').value = imagensExcluidas.join(',');
  }


  function removerImagem(button) {
    const imagemId = button.getAttribute('data-imagem-id');
    // Adiciona o ID da imagem no campo oculto
    let imagensExcluidas = document.getElementById('imagensExcluidas').value;
    imagensExcluidas = imagensExcluidas ? imagensExcluidas.split(',') : [];
    imagensExcluidas.push(imagemId);
    document.getElementById('imagensExcluidas').value = imagensExcluidas.join(',');

    button.closest('.col-md-3').remove();
  }

  // Exemplo de envio assíncrono usando fetch
  function uploadImage(file) {
    const formData = new FormData();
    formData.append('image', file);

    fetch('/upload', {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(data => {
      if (data.success) {
        // Exibe a imagem no site após o upload
        const imgElement = document.createElement('img');
        imgElement.src = data.imageUrl;  // Supondo que o servidor retorna a URL da imagem
        document.getElementById('preview-container').appendChild(imgElement);
      }
    })
      .catch(error => console.error('Erro ao fazer o upload da imagem:', error));
  }


</script>

</body>
</html>
